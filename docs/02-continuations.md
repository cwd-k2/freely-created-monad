# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ç¶™ç¶šã§æ›¸ã‘ã‚‹

DSL ã‚’æ§‹æˆã™ã‚‹ã«ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼â€”â€”ã€Œæ¬¡ã«ä½•ã‚’ã™ã‚‹ã‹ã€â€”â€”ã‚’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ“ä½œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã«ã¾ãšã€ã€Œæ®‹ã‚Šã®è¨ˆç®—ã€ã‚’å€¤ã¨ã—ã¦æ‰±ã†æŠ€æ³•ã€**ç¶™ç¶š**ã‚’å°Žå…¥ã—ã¾ã™ã€‚

## ç›´æŽ¥ã‚¹ã‚¿ã‚¤ãƒ«ã¨ CPS

é€šå¸¸ã€é–¢æ•°ã¯è¨ˆç®—çµæžœã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ï¼ˆç›´æŽ¥ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã€‚

```haskell
add :: Int -> Int -> Int
add x y = x + y

square :: Int -> Int
square x = x * x

-- (3 + 4)^2
directExample = square (add 3 4)
```

**CPSï¼ˆContinuation-Passing Styleï¼‰** ã§ã¯ã€ã€Œè¨ˆç®—çµæžœã‚’ã©ã†ã™ã‚‹ã‹ã€ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™ã€‚

```haskell
addCPS :: Int -> Int -> (Int -> r) -> r
addCPS x y k = k (x + y)

squareCPS :: Int -> (Int -> r) -> r
squareCPS x k = k (x * x)
```

`k` ãŒ **ç¶™ç¶šï¼ˆcontinuationï¼‰** ã§ã™ã€‚ã€Œã“ã®è¨ˆç®—ã®å¾Œã«ã‚„ã‚‹ã“ã¨ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

```haskell
-- (3 + 4)^2 ã‚’ CPS ã§
cpsExample = addCPS 3 4 (\n -> squareCPS n (\result -> result))
```

## CPS ã®åˆæˆ

CPS è¨ˆç®—ã«ã¯å…±é€šã®åž‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

```haskell
type Cont r a = (a -> r) -> r
```

ã€Œ`a` åž‹ã®å€¤ã‚’ç”Ÿã¿å‡ºã™è¨ˆç®—ã§ã€ãã®å€¤ã®ä½¿ã„æ–¹ï¼ˆ`a -> r`ï¼‰ã‚’å—ã‘å–ã£ã¦æœ€çµ‚çµæžœ `r` ã‚’è¿”ã™ã€ã¨èª­ã‚ã¾ã™ã€‚

ã“ã®åž‹ã«å¯¾ã—ã¦ã€è¨ˆç®—ã‚’é€£éŽ–ã•ã›ã‚‹é–¢æ•°ãŒè‡ªç„¶ã«å®šç¾©ã§ãã¾ã™ã€‚

```haskell
bindCont :: Cont r a -> (a -> Cont r b) -> Cont r b
bindCont m f = \k -> m (\a -> f a k)
```

`bindCont` ã¯ã€Œæœ€åˆã®è¨ˆç®— `m` ã‚’å®Ÿè¡Œã—ã€ãã®çµæžœ `a` ã‚’ä½¿ã£ã¦æ¬¡ã®è¨ˆç®— `f a` ã‚’å®Ÿè¡Œã—ã€æœ€çµ‚çš„ãªç¶™ç¶š `k` ã«æ¸¡ã™ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚ã“ã®**è¨ˆç®—ã‚’éŽ–ã®ã‚ˆã†ã«ç¹‹ã’ã‚‹**æ“ä½œã“ããŒã€å¾Œã«ç™»å ´ã™ã‚‹ãƒ¢ãƒŠãƒ‰ã® `>>=`ï¼ˆbindï¼‰ã®åŽŸåž‹ã§ã‚ã‚Šã€æœ¬è³‡æ–™å…¨ä½“ã‚’è²«ãä¸­å¿ƒçš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã€‚

## ç¶™ç¶šãŒã‚‚ãŸã‚‰ã™ã‚‚ã®

CPS ã«å¤‰æ›ã™ã‚‹ã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã€Œæ®‹ã‚Šã®è¨ˆç®—ã€ãŒ**é–¢æ•°ã¨ã—ã¦æ˜Žç¤ºåŒ–**ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šï¼š

- **è¨ˆç®—ã®ä¸­æ–­ã¨å†é–‹** ãŒè¡¨ç¾ã§ãã‚‹ï¼ˆç¶™ç¶šã‚’ä¿å­˜ã—ã¦ãŠã‘ã°ã‚ˆã„ï¼‰
- **è¨ˆç®—ã®åˆæˆ** ãŒä½“ç³»çš„ã«ã§ãã‚‹ï¼ˆ`bindCont`ï¼‰
- **åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼** ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒžãŒè‡ªç”±ã«æ“ä½œã§ãã‚‹

ã—ã‹ã—ã€CPS ã§ã¯ç¶™ç¶šã¯**é–¢æ•°**ã§ã™ã€‚é–¢æ•°ã¯å‘¼ã¶ã“ã¨ã—ã‹ã§ããšã€ã€Œã“ã®è¨ˆç®—ã¯ä½•ã‚’ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã‹ã€ã‚’å¤–ã‹ã‚‰è¦‹ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ch01 ã§æŽ²ã’ãŸã€Œå®Ÿè¡Œæ–¹æ³•ã‚’å¾Œã‹ã‚‰å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ã€DSL ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãŒå‘½ä»¤ã®ç¨®é¡žã‚’è­˜åˆ¥ã—ã¦å‡¦ç†ã‚’åˆ†å²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€ç¶™ç¶šã‚’é–¢æ•°ã®ã¾ã¾æŒã¤ã®ã§ã¯ãªãã€**ãƒ‡ãƒ¼ã‚¿**ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ç« ã§ã¯ã€é–¢æ•°ã‚’ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹æ‰‹æ³•ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

> ðŸ“– å¯¾å¿œã‚³ãƒ¼ãƒ‰: [`haskell/src/Continuation.hs`](../haskell/src/Continuation.hs)
