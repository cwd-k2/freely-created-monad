# è£œéº: Codensity ãƒ¢ãƒŠãƒ‰

ch04 ã§ã€Freer ãƒ¢ãƒŠãƒ‰ã® `>>=` ã¯å·¦çµåˆãƒã‚§ãƒ¼ãƒ³ã§ O(nÂ²) ã«ãªã‚Šå¾—ã‚‹ã¨æŒ‡æ‘˜ã—ã¾ã—ãŸã€‚ã¾ãŸ ch05 ã§ã¯ã€Generator ã® one-shot åˆ¶ç´„ã«è§¦ã‚Œã¾ã—ãŸã€‚ã“ã“ã§ã¯ã“ã‚Œã‚‰ã®è©±é¡Œã‚’çµ±ä¸€çš„ã«æ‰±ã„ã¾ã™ã€‚

## Codensity ãƒ¢ãƒŠãƒ‰

Freer ãƒ¢ãƒŠãƒ‰ã® `>>=` ã¯ç¶™ç¶šã‚’é–¢æ•°åˆæˆã§é€£éŽ–ã•ã›ã¾ã™ã€‚

```haskell
Bind fx k >>= f = Bind fx ((>>= f) . k)
```

å·¦çµåˆã® `>>=` ãƒã‚§ãƒ¼ãƒ³ `(((m >>= f) >>= g) >>= h)` ã§ã¯ç¶™ç¶šãŒå…¥ã‚Œå­ã«ãªã‚Šã€å®Ÿè¡Œæ™‚ã« O(nÂ²) ã®ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šå¾—ã¾ã™ã€‚

**Codensity ãƒ¢ãƒŠãƒ‰** ã¯ã“ã®å•é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚

```haskell
newtype Codensity m a = Codensity
  { runCodensity :: forall r. (a -> m r) -> m r }
```

ã“ã‚Œã¯ã€ŒCPS å¤‰æ›ã•ã‚ŒãŸãƒ¢ãƒŠãƒ‰ã€ã§ã™ã€‚Monad ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ï¼š

```haskell
instance Monad (Codensity m) where
  Codensity m >>= f = Codensity (\k -> m (\a -> runCodensity (f a) k))
```

`>>=` ãŒå¸¸ã« **O(1)** ã«ãªã‚Šã¾ã™ã€‚ç¶™ç¶šã®çµåˆæ–¹å‘ãŒå³çµåˆã«çŸ¯æ­£ã•ã‚Œã‚‹ãŸã‚ã§ã™ã€‚

ãƒªã‚¹ãƒˆã® `(++)` ãŒå·¦çµåˆã§ O(nÂ²) ã«ãªã‚‹ã®ã‚’å·®åˆ†ãƒªã‚¹ãƒˆ `[a] -> [a]` ã§ O(n) ã«ã™ã‚‹ã®ã¨åŒã˜ç™ºæƒ³ã§ã™ã€‚

## ãƒ‘ãƒ©ãƒ¡ãƒˆãƒªã‚·ãƒ†ã‚£

Codensity ã®åž‹ã‚’ã‚‚ã†ä¸€åº¦è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```haskell
forall r. (a -> m r) -> m r
```

`forall r.` ã¯ã€Œ**ä»»æ„ã®** åž‹ `r` ã«å¯¾ã—ã¦å‹•ä½œã™ã‚‹ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒˆãƒªã‚·ãƒ†ã‚£ï¼ˆparametricityï¼‰ã«ã‚ˆã‚Šã€ã“ã®åž‹ã®å€¤ `m` ã¯ `r` ã«ã¤ã„ã¦**ä½•ã‚‚çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“**ã€‚

å…·ä½“çš„ã«ã¯ã€`m` ã«ã§ãã‚‹ã“ã¨ã¯ï¼š

1. æ‰‹å…ƒã® `a` åž‹ã®å€¤ã‚’ç¶™ç¶š `k : a -> m r` ã«æ¸¡ã—ã¦ `m r` ã‚’å¾—ã‚‹
2. å¾—ã‚‰ã‚ŒãŸ `m r` ã‚’ãã®ã¾ã¾è¿”ã™

ã“ã‚Œ**ã ã‘**ã§ã™ã€‚`r` ãŒä½•ã§ã‚ã‚‹ã‹ã«ã‚ˆã£ã¦æŒ¯ã‚‹èˆžã„ã‚’å¤‰ãˆã‚‹ã“ã¨ã¯ä¸å¯èƒ½ã§ã™ã€‚`m r` ã®ä¸­èº«ã‚’èª¿ã¹ã‚‹ã“ã¨ã‚‚ã€`r` åž‹ã®å€¤ã‚’ç‹¬è‡ªã«æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚

å®Ÿéš›ã«ã€Codensity ã® `>>=` ãŒçµåˆå¾‹ã‚’æº€ãŸã™ã“ã¨ã¯ç›´æŽ¥è¨ˆç®—ã§ç¢ºèªã§ãã¾ã™ã€‚

```
(Codensity m >>= f) >>= g
= Codensity (\k -> m (\a -> runCodensity (f a) (\b -> runCodensity (g b) k)))

Codensity m >>= (\a -> f a >>= g)
= Codensity (\k -> m (\a -> runCodensity (f a >>= g) k))
= Codensity (\k -> m (\a -> runCodensity (f a) (\b -> runCodensity (g b) k)))
```

ä¸¡è¾ºãŒä¸€è‡´ã—ã¾ã™ã€‚ã“ã®è¨ˆç®—ãŒæˆã‚Šç«‹ã¤èƒŒæ™¯ã«ã¯**ãƒ‘ãƒ©ãƒ¡ãƒˆãƒªã‚·ãƒ†ã‚£**ãŒã‚ã‚Šã¾ã™ã€‚`forall r.` ã«ã‚ˆã‚Š `Codensity m a` ã®å€¤ã¯ `r` ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚‹ã“ã¨ãŒã§ããšã€ç¶™ç¶šã‚’ã€Œå‘¼ã¶ä»¥å¤–ã«ä½•ã‚‚ã§ããªã„ã€ãŸã‚ã€ç¶™ç¶šã®åˆæˆé †åºã‚’è‡ªç”±ã«çµ„ã¿æ›¿ãˆã¦ã‚‚è¦³æ¸¬å¯èƒ½ãªå·®ãŒç”Ÿã˜ã¾ã›ã‚“ã€‚

ã“ã‚Œã¯å·®åˆ†ãƒªã‚¹ãƒˆã®å ´åˆã¨åŒæ§˜ã§ã™ã€‚`\xs -> [1,2,3] ++ xs` ã¨ã„ã†é–¢æ•°ã«å¯¾ã—ã¦ã€`xs` ã®å…·ä½“çš„ãªä¸­èº«ã¯è¦‹ãˆã¾ã›ã‚“ã€‚ã ã‹ã‚‰ `(f . g) . h` ã¨ `f . (g . h)` ã‚’åŒºåˆ¥ã™ã‚‹æ–¹æ³•ãŒãªãã€é–¢æ•°åˆæˆã®çµåˆå¾‹ãŒãã®ã¾ã¾ãƒªã‚¹ãƒˆã® `(++)` ã®çµåˆå¾‹ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

## Freer ã¨ã®æŽ¥ç¶š

Freer ã® `>>=` ãŒå·¦çµåˆã§ O(nÂ²) ã«ãªã‚‹å•é¡Œã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®**æ§‹ç¯‰æ™‚**ã« `Codensity (Freer f)` ã‚’ä½¿ã„ã€**å®Ÿè¡Œæ™‚**ã« `lowerCodensity` ã§æˆ»ã™ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚

```haskell
liftCodensity :: Monad m => m a -> Codensity m a
liftCodensity m = Codensity (m >>=)

lowerCodensity :: Monad m => Codensity m a -> m a
lowerCodensity (Codensity f) = f pure
```

do è¨˜æ³•ã¯ `>>=` ã‚’**å³çµåˆã«ãƒ‡ã‚·ãƒ¥ã‚¬ãƒ¼**ã™ã‚‹ãŸã‚ã€do è¨˜æ³•ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ„ã¿ç«‹ã¦ã‚‹é™ã‚Šã“ã®å•é¡Œã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚å·¦çµåˆãƒã‚§ãƒ¼ãƒ³ãŒç¾ã‚Œã‚‹ã®ã¯ã€do è¨˜æ³•ã®å¤–ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã« `>>=` ã‚’åå¾©é©ç”¨ã™ã‚‹å ´åˆï¼ˆä¾‹: `foldl (>>=) m fs`ï¼‰ã«é™ã‚‰ã‚Œã¾ã™ã€‚æœ¬è³‡æ–™ã® DSL å®Ÿè£…ã¯ do è¨˜æ³•ï¼ˆTypeScript ã§ã¯ Generatorï¼‰ã®ã¿ã‚’ä½¿ã†ãŸã‚ã€Codensity ã«ã‚ˆã‚‹æœ€é©åŒ–ã¯è¡Œã„ã¾ã›ã‚“ã€‚

## one-shot ã¨ Codensity ã®é–¢ä¿‚

Codensity ã«ã‚ˆã‚‹æœ€é©åŒ–ãŒæ©Ÿèƒ½ã™ã‚‹ã®ã¯ã€ç¶™ç¶šã‚’**é–¢æ•°ã¨ã—ã¦è‡ªç”±ã«åˆæˆãƒ»å†æ§‹æˆã§ãã‚‹**ã‹ã‚‰ã§ã™ã€‚Haskell ã® Freer ã§ã¯ç¶™ç¶š `(x -> Freer f a)` ã¯é€šå¸¸ã®é–¢æ•°ãªã®ã§ã“ã‚ŒãŒå¯èƒ½ã§ã™ãŒã€ç¶™ç¶šãŒ**ä¸€åº¦ã—ã‹ä½¿ãˆãªã„**ï¼ˆone-shotï¼‰ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã¯ã€åˆæˆã®å†çµåˆè‡ªä½“ãŒæ„å‘³ã‚’æŒã¡ã¾ã›ã‚“ã€‚TypeScript ã® Generator ã¯ã¾ã•ã«ã“ã® one-shot ã®åˆ¶ç´„ã‚’æŒã£ã¦ãŠã‚Šã€Codensity ãŒä¸è¦ã§ã‚ã‚‹ã ã‘ã§ãªãã€ãã‚‚ãã‚‚é©ç”¨ã§ããªã„ã¨ã„ã†äº‹æƒ…ãŒã‚ã‚Šã¾ã™ã€‚

> ðŸ“– å¯¾å¿œã‚³ãƒ¼ãƒ‰: [`haskell/src/Codensity.hs`](../haskell/src/Codensity.hs)
