# è‡ªç”±ãƒ¢ãƒŠãƒ‰

## ãªãœãƒ¢ãƒŠãƒ‰ãŒå¿…è¦ã‹

å‰ç« ã§ã€å‘½ä»¤ã‚’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¡¨ç¾ã™ã‚‹æ‰‹æ³•ï¼ˆDefunctionalizationï¼‰ã‚’è¦‹ã¾ã—ãŸã€‚ã§ã¯ã€å‘½ä»¤ã‚’ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ã ã‘ã§ DSL ã¯æ›¸ã‘ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

```typescript
// å‘½ä»¤ã®ãƒªã‚¹ãƒˆâ€”â€”ã“ã‚Œã ã‘ã§ååˆ†ï¼Ÿ
const program: TalkInstruction[] = [
  { tag: "ask", prompt: "åå‰ã¯ï¼Ÿ" },
  { tag: "tell", message: "ã“ã‚“ã«ã¡ã¯" },  // â† å›ºå®šæ–‡å­—åˆ—ã—ã‹æ›¸ã‘ãªã„
];
```

ã“ã‚Œã¯ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ã€ã€Œå®Ÿè¡Œã‚’å¾Œã‹ã‚‰æ±ºã‚ã‚‰ã‚Œã‚‹ã€ã¨ã„ã†æ€§è³ªã‚’æº€ãŸã—ã¾ã™ãŒã€æ±ºå®šçš„ã«è¶³ã‚Šãªã„ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚**å¾Œã®å‘½ä»¤ãŒå‰ã®å‘½ä»¤ã®çµæœã«ä¾å­˜ã™ã‚‹**ã“ã¨ã‚’è¡¨ç¾ã§ãã¾ã›ã‚“ã€‚

```typescript
const name = yield* ask("åå‰ã¯ï¼Ÿ");
yield* tell(`ã“ã‚“ã«ã¡ã¯ã€${name}ã•ã‚“ï¼`);
//                       ^^^^ ask ã®çµæœã«ä¾å­˜
```

`tell` ã®å†…å®¹ãŒ `ask` ã®çµæœã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚å‘½ä»¤åˆ—ãŒé™çš„ã«æ±ºã¾ã‚‹ãªã‚‰ `Instruction[]` ã§ååˆ†ã§ã™ãŒã€ã“ã®**ä¾å­˜çš„ãªé€æ¬¡å®Ÿè¡Œ**ã‚’è¡¨ç¾ã™ã‚‹ã«ã¯ã€å‘½ä»¤ã®é–“ã«ã€Œçµæœã‚’å—ã‘å–ã£ã¦æ¬¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ±ºã‚ã‚‹é–¢æ•°ã€â€”â€”ã¤ã¾ã‚Š**ç¶™ç¶š**â€”â€”ãŒå¿…è¦ã§ã™ã€‚

```
å‘½ä»¤ â†’ çµæœ â†’ (çµæœã«åŸºã¥ã„ã¦æ¬¡ã®å‘½ä»¤ã‚’é¸ã¶) â†’ çµæœ â†’ ...
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
              ã“ã®é–¢æ•°ãŒ >>=ï¼ˆbindï¼‰ã®ç¬¬äºŒå¼•æ•°
```

ã“ã‚Œã¯ã¾ã•ã« `>>=` ã®å‹ã§ã‚ã‚Šã€ãƒ¢ãƒŠãƒ‰æ§‹é€ ãŒå¿…è¦ãªç†ç”±ã§ã™ã€‚

```haskell
(>>=) :: Freer f a -> (a -> Freer f b) -> Freer f b
--                     ^^^^^^^^^^^^^^^^
--                     å‰ã®çµæœã«å¿œã˜ã¦æ¬¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’é¸ã¶
```

å‰ç« ã§ `ContChain` ã® `(a -> b)` ã‚’ã€Œã¾ã é–¢æ•°ãŒæ®‹ã£ã¦ã„ã‚‹ã€ã¨æŒ‡æ‘˜ã—ã¾ã—ãŸã€‚ã“ã®é–¢æ•°ã¯æ¶ˆã›ã¾ã›ã‚“â€”â€”**ä¾å­˜çš„ãªé€æ¬¡å®Ÿè¡Œã®æœ¬è³ª**ã ã‹ã‚‰ã§ã™ã€‚æ¶ˆã™ã¹ããªã®ã¯é–¢æ•°ã®ä¸é€æ˜ã•ã§ã‚ã‚Šã€é–¢æ•°ã®å­˜åœ¨ãã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã®ç« ã§ã¯ã€`(a -> b)` ã®æ§‹é€ ã‚’æ˜ã‚‰ã‹ã«ã—ã€è‡ªç”±ãƒ¢ãƒŠãƒ‰ã‚’å°å‡ºã—ã¾ã™ã€‚

## ç¶™ç¶šã®ãƒã‚§ãƒ¼ãƒ³ã«æ®‹ã£ãŸé–¢æ•°

å‰ç« ã§ã€ç¶™ç¶šã®ãƒã‚§ãƒ¼ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã‚ˆã†ã¨ã—ãŸã¨ãã€æ¬¡ã®ã‚ˆã†ãªå‹ã«è¾¿ã‚Šç€ãã¾ã—ãŸã€‚

```haskell
data ContChain a
  = DoneChain
  | forall b. StepChain (a -> b) (ContChain b)
```

`StepChain` ã® `(a -> b)` ã¯ã€Œä»Šã®å€¤ `a` ã‚’å—ã‘å–ã‚Šã€ä½•ã‹ã‚’ã—ã¦æ¬¡ã®å€¤ `b` ã‚’ç”Ÿã¿å‡ºã™ã€é–¢æ•°ã§ã™ã€‚ã“ã®é–¢æ•°ã¯å®Œå…¨ã«ä¸é€æ˜ã§ã€Defunctionalization ã§ãã¦ã„ã¾ã›ã‚“ã€‚

### (a -> b) ã®ä¸­èº«ã‚’åˆ†è§£ã™ã‚‹

ã“ã® `(a -> b)` ã¯å®Ÿéš›ã«ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿä¸€èˆ¬ã®é–¢æ•° `(a -> b)` ã¯ä»»æ„ã®è¨ˆç®—ã‚’è¡¨ã›ã‚‹ã®ã§ã€ã“ã‚Œä»¥ä¸Šåˆ†è§£ã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ã“ã“ã§æ€ã„å‡ºã™ã¹ãã¯ã€ç§ãŸã¡ãŒæ§‹ç¯‰ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã¯ **DSL** ã ã¨ã„ã†ã“ã¨ã§ã™ã€‚

DSL ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€Œä½•ã‚‰ã‹ã®é›¢æ•£çš„ãªå‘½ä»¤ã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’ä½¿ã£ã¦æ¬¡ã«é€²ã‚€ã€ã¨ã„ã†æ§‹é€ ã‚’æŒã¡ã¾ã™ã€‚

```
ask "åå‰ã¯ï¼Ÿ"  â†’  (\name -> tell ("ã“ã‚“ã«ã¡ã¯ã€" ++ name) â†’ (\() -> ...))
```

ã“ã®å‰æã®ã‚‚ã¨ã§ `(a -> b)` ã‚’è¦³å¯Ÿã™ã‚‹ã¨ã€å…±é€šã®æ§‹é€ ãŒè¦‹ãˆã¦ãã¾ã™ã€‚

1. **ä½•ã‚‰ã‹ã®å‘½ä»¤ã‚’å®Ÿè¡Œã™ã‚‹**ï¼ˆ`ask "åå‰ã¯ï¼Ÿ"`ã€`tell "ã“ã‚“ã«ã¡ã¯"`ï¼‰
2. **å‘½ä»¤ã®çµæœã‚’å—ã‘å–ã‚‹**ï¼ˆ`ask` ãªã‚‰ `String`ã€`tell` ãªã‚‰ `()`ï¼‰
3. **ãã®çµæœã‚’ä½¿ã£ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€**

ã¤ã¾ã‚Š DSL ã®æ–‡è„ˆã§ã¯ã€`(a -> b)` ã¯ã€Œ**å‘½ä»¤ãƒ‡ãƒ¼ã‚¿ + çµæœã‚’å—ã‘å–ã‚‹ç¶™ç¶š**ã€ã«åˆ†è§£ã§ãã¾ã™ã€‚ã“ã‚Œã¯ä¸€èˆ¬çš„ãªå®šç†ã§ã¯ãªãã€ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯é›¢æ•£çš„ãªå‘½ä»¤ã®åˆ—ã§ã‚ã‚‹ã€ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä»®å®šã«åŸºã¥ãè¨­è¨ˆä¸Šã®é¸æŠã§ã™ã€‚

### Functor ã«ã‚ˆã‚‹æ§‹é€ åŒ–

ã“ã®åˆ†è§£ã‚’å‹ã§è¡¨ã™ã¨ï¼š

```haskell
data TalkF next
  = Ask String (String -> next)   -- å‘½ä»¤ãƒ‡ãƒ¼ã‚¿: Ask prompt
                                  -- çµæœå‹: String
                                  -- ç¶™ç¶š: String -> next
  | Tell String next              -- å‘½ä»¤ãƒ‡ãƒ¼ã‚¿: Tell msg
                                  -- çµæœå‹: ()
                                  -- ç¶™ç¶š: () -> next ï¼ˆç°¡ç•¥åŒ–ã—ã¦ç›´æ¥ nextï¼‰
```

å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `next` ãŒã€Œã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã«ä½•ãŒç¶šãã‹ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

`ContChain` ã¨ã®å¯¾å¿œã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä¸¡è€…ã®å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ç•°ãªã‚‹å½¹å‰²ã‚’æŒã¤ï¼ˆ`ContChain a` ã® `a` ã¯ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã®å…¥åŠ›å‹ã€`Free f a` ã® `a` ã¯æœ€çµ‚çµæœå‹ï¼‰ãŸã‚ã€å³å¯†ãªåŒå‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€**æ§‹é€ ã¯å…±é€š**ã—ã¦ã„ã¾ã™ã€‚

```
ContChain:   StepChain  (a -> b)        (ContChain b)
                         ^^^^^^^^        ^^^^^^^^^^^^
                         ä¸é€æ˜ãªé–¢æ•°      æ®‹ã‚Šã®ãƒã‚§ãƒ¼ãƒ³

Free:        Free       (f next)        â€» next = Free f a
                         ^^^^^^
                         æ§‹é€ åŒ–ã•ã‚ŒãŸå‘½ä»¤ + æ®‹ã‚Šã®ãƒã‚§ãƒ¼ãƒ³
```

æ ¸å¿ƒã¯ã€ä¸é€æ˜ã ã£ãŸ `(a -> b)` ãŒ `f next` ã¨ã—ã¦æ§‹é€ åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚ãŸã ã—ã€å®Œå…¨ã« Defunctionalization ã•ã‚ŒãŸã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

- `f` ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ï¼ˆ`Ask prompt` ã‚„ `Tell msg`ï¼‰â†’ å‘½ä»¤ã®ç¨®é¡ã¨å¼•æ•°ã€‚Defunctionalization ã•ã‚Œã¦ã„ã‚‹
- `Ask` ã® `(String -> next)` â†’ çµæœã‚’å—ã‘å–ã‚‹**ç¶™ç¶š**ã€‚é–¢æ•°ã®ã¾ã¾æ®‹ã£ã¦ã„ã‚‹

ã¤ã¾ã‚Š Free ãƒ¢ãƒŠãƒ‰ã®å‘½ä»¤ã‚»ãƒƒãƒˆã¯ã€Œ**å‘½ä»¤ã® Defunctionalization + ç¶™ç¶šã®æ§‹é€ åŒ–**ã€ã§ã™ã€‚å‘½ä»¤ãŒä½•ã‚’ã™ã‚‹ã‹ã¯ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€ç¶™ç¶šï¼ˆçµæœã‚’ä½¿ã£ã¦æ¬¡ã«ä½•ã‚’ã™ã‚‹ã‹ï¼‰ã¯ä¾ç„¶ã¨ã—ã¦é–¢æ•°ã§ã™ã€‚

`f` ãŒ Functor ã§ã‚ã‚‹ã¨ã¯ã€`fmap` ã§ã€Œå‘½ä»¤ã®å†…å®¹ã‚’å¤‰ãˆãšã«ã€ç¶šãå…ˆï¼ˆ`next`ï¼‰ã ã‘ã‚’å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚

## è‡ªç”±ãƒ¢ãƒŠãƒ‰ã®å®šç¾©

å‰ç¯€ã®åˆ†è§£â€”â€”ä¸é€æ˜ãª `(a -> b)` ã‚’å‘½ä»¤ `f` ã¨ã—ã¦æ§‹é€ åŒ–ã™ã‚‹â€”â€”ã‚’ `ContChain` ã«é©ç”¨ã™ã‚‹ã¨ã€è‡ªç”±ãƒ¢ãƒŠãƒ‰ï¼ˆFree Monadï¼‰ã®å®šç¾©ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

ãŸã ã— `ContChain` ã¨ Free ã¯å‹ã®å½¹å‰²ãŒç•°ãªã‚‹ï¼ˆ`ContChain` ã¯å¤‰æ›ã®ãƒã‚§ãƒ¼ãƒ³ã€Free ã¯çµæœã‚’æŒã¤è¨ˆç®—ï¼‰ãŸã‚ã€å³å¯†ãªåŒå‹ã§ã¯ãªãã€åŒã˜ã€Œå‘½ä»¤ã®ãƒã‚§ãƒ¼ãƒ³ã€ã¨ã„ã†ç™ºæƒ³ã‚’è¨ˆç®—ã®ãƒ¢ãƒŠãƒ‰ã¨ã—ã¦å†å®šå¼åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚

```haskell
data Free f a
  = Pure a                  -- è¨ˆç®—å®Œäº†ã€å€¤ a ã‚’æŒã¤
  | Free (f (Free f a))    -- å‘½ä»¤ f ã‚’ä¸€ã¤å®Ÿè¡Œã—ã€æ®‹ã‚Šã®è¨ˆç®—ãŒç¶šã
```

- `Pure a` â€” ã€Œã‚‚ã†ä½•ã‚‚ã—ãªãã¦ã„ã„ã€çµæœã¯ `a`ã€
- `Free (f (Free f a))` â€” ã€Œå‘½ä»¤ `f` ã‚’ä¸€ã¤å®Ÿè¡Œã—ã€ãã®ä¸­ã«æ®‹ã‚Šã®è¨ˆç®—ï¼ˆ`Free f a`ï¼‰ãŒå…¥ã£ã¦ã„ã‚‹ã€

`f` ãŒ Functor ã§ã‚ã‚Œã°ã€ã“ã‚Œã¯è‡ªå‹•çš„ã« Monad ã«ãªã‚Šã¾ã™ã€‚

## Monad ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

```haskell
instance Functor f => Monad (Free f) where
  Pure a >>= f = f a                      -- å€¤ãŒã‚ã‚Œã°ãã®ã¾ã¾é–¢æ•°ã‚’é©ç”¨
  Free fx >>= f = Free (fmap (>>= f) fx)  -- å‘½ä»¤ã®ã€Œä¸­ã€ã«æ½œã£ã¦å†å¸°çš„ã« >>= ã‚’é©ç”¨
```

`>>=`ï¼ˆbindï¼‰ã®å‹•ä½œï¼š

- `Pure a` ã®å ´åˆï¼šå˜ã« `f a` ã‚’è¿”ã™ã€‚ç¶™ç¶šã‚’ç›´æ¥é©ç”¨ã€‚
- `Free fx` ã®å ´åˆï¼šå‘½ä»¤ `fx` ã®ä¸­ã«ã‚ã‚‹ã€Œæ®‹ã‚Šã®è¨ˆç®—ã€ã«å¯¾ã—ã¦å†å¸°çš„ã« `>>= f` ã‚’é©ç”¨ã™ã‚‹ã€‚ã¤ã¾ã‚Šã€å‘½ä»¤ãƒã‚§ãƒ¼ãƒ³ã®**æœ«å°¾ã«æ–°ã—ã„è¨ˆç®—ã‚’æ¥ãæœ¨**ã™ã‚‹ã€‚ã“ã®ã€Œæ¥ãæœ¨ã€ã¯æ¯å›ãƒã‚§ãƒ¼ãƒ³ã®å…ˆé ­ã‹ã‚‰æœ«ç«¯ã¾ã§ã‚’è¾¿ã‚Šç›´ã™ãŸã‚ã€ãƒã‚§ãƒ¼ãƒ³ãŒé•·ããªã‚‹ã¨æ€§èƒ½å•é¡Œã«ç¹‹ãŒã‚Šã¾ã™ï¼ˆå¾Œã®ç« ã§è§£æ±ºã—ã¾ã™ï¼‰ã€‚

## å…·ä½“ä¾‹: å…¥å‡ºåŠ›ã® DSL

å‘½ä»¤ã‚»ãƒƒãƒˆã‚’ Functor ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚

```haskell
data TalkF next
  = Ask String (String -> next)   -- è³ªå•ã—ã¦ã€ç­”ãˆã‚’ä½¿ã£ã¦æ¬¡ã¸
  | Tell String next              -- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦æ¬¡ã¸
  deriving Functor
```

`TalkF` ã®å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `next` ãŒã€Œæ¬¡ã®è¨ˆç®—ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚`deriving Functor` ã§ã€`next` ã®éƒ¨åˆ†ã«é–¢æ•°ã‚’é©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

å‘½ä»¤ã‚’ Free ãƒ¢ãƒŠãƒ‰ã«æŒã¡ä¸Šã’ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚

```haskell
liftFree :: Functor f => f a -> Free f a
liftFree fx = Free (fmap Pure fx)
-- å‘½ä»¤ fx ã®ã€Œæ¬¡ã®è¨ˆç®—ã€ã‚’ Pureï¼ˆ= è¨ˆç®—å®Œäº†ï¼‰ã«ã—ã¦åŒ…ã‚€
```

ã“ã‚Œã‚’ä½¿ã£ã¦ä¾¿åˆ©ãªå‘½ä»¤é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

```haskell
ask :: String -> Free TalkF String
ask prompt = liftFree (Ask prompt id)

tell :: String -> Free TalkF ()
tell msg = liftFree (Tell msg ())
```

do è¨˜æ³•ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ›¸ã‘ã¾ã™ã€‚

```haskell
talkProgram :: Free TalkF String
talkProgram = do
  name <- ask "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  tell ("ã“ã‚“ã«ã¡ã¯ã€" ++ name ++ "ã•ã‚“ï¼")
  age <- ask "å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  tell (age ++ "æ­³ã§ã™ã­ã€‚")
  pure name
```

ã“ã® `talkProgram` ã¯ **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ** ã§ã™ã€‚å®Ÿè¡Œã¯ã¾ã è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

## ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿: ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å®Ÿè¡Œã¸

åŒã˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å¯¾ã—ã¦ç•°ãªã‚‹ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã‚’å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ã®ãŒ Free ãƒ¢ãƒŠãƒ‰ã®å¼·ã¿ã§ã™ã€‚

```haskell
-- IO ã§å¯¾è©±çš„ã«å®Ÿè¡Œ
runTalkIO :: Free TalkF a -> IO a
runTalkIO (Pure a) = pure a
runTalkIO (Free (Ask prompt next)) = do
  putStrLn prompt
  input <- getLine
  runTalkIO (next input)
runTalkIO (Free (Tell msg next)) = do
  putStrLn msg
  runTalkIO next

-- ç´”ç²‹ãªã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
runTalkPure :: [String] -> Free TalkF a -> (a, [String])
```

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®**å®šç¾©**ã¨**å®Ÿè¡Œ**ãŒå®Œå…¨ã«åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚

## Free ãƒ¢ãƒŠãƒ‰ã®èª²é¡Œ

Free ãƒ¢ãƒŠãƒ‰ã¯å¼·åŠ›ã§ã™ãŒã€å‘½ä»¤ã‚»ãƒƒãƒˆ `f` ã« **Functor åˆ¶ç´„ãŒå¿…è¦** ã§ã™ã€‚

```haskell
data TalkF next
  = Ask String (String -> next)   -- â† ã“ã® (String -> next) ãŒ Functor ã®ãŸã‚ã«å¿…è¦
  | Tell String next
```

`Ask` ã®ç¬¬2å¼•æ•° `(String -> next)` ã¯ã€Functor ã® `fmap` ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã ã‘ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚å‰ç¯€ã§ã€Œå‘½ä»¤ã® Defunctionalization + ç¶™ç¶šã®æ§‹é€ åŒ–ã€ã¨è¿°ã¹ã¾ã—ãŸãŒã€ã“ã® `(String -> next)` ã¯ã¾ã•ã«æ§‹é€ åŒ–ã•ã‚ŒãŸã¾ã¾æ®‹ã£ã¦ã„ã‚‹ç¶™ç¶šã®éƒ¨åˆ†ã§ã‚ã‚Šã€å®šå‹çš„ã§ã€å‘½ä»¤ã®æœ¬è³ªçš„ãªæƒ…å ±ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚

æ¬¡ç« ã§ã€ã“ã® Functor åˆ¶ç´„ã‚’å–ã‚Šé™¤ãæ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

> ğŸ“– å¯¾å¿œã‚³ãƒ¼ãƒ‰: [`haskell/src/Free.hs`](../haskell/src/Free.hs)
