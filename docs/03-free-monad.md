# è‡ªç”±ãƒ¢ãƒŠãƒ‰ã¨ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ

å‰ç« ã§ã€CPS ã¨ Defunctionalization ã«ã‚ˆã£ã¦è¨ˆç®—ã‚’å…·è±¡åŒ–ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¾ã—ãŸã€‚ã—ã‹ã—ç¶™ç¶šã®ãƒã‚§ãƒ¼ãƒ³ `ContChain` ã«ã¯ä¸é€æ˜ãªé–¢æ•° `(a -> b)` ãŒæ®‹ã£ã¦ã„ã¾ã—ãŸã€‚ã“ã®ç« ã§ã¯ãã®é–¢æ•°ã®æ§‹é€ ã‚’æ˜ã‚‰ã‹ã«ã—ã€è‡ªç”±ãƒ¢ãƒŠãƒ‰ã‚’å°å‡ºã—ã¾ã™ã€‚ãã—ã¦ã€è‡ªç”±ãƒ¢ãƒŠãƒ‰ã®ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãŒæŒã¤**ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ**â€”â€”ã€Œå…ˆé ­ã‚’è¦—ãã€å‘½ä»¤ã‚’å‡¦ç†ã—ã€ç¶™ç¶šã«å€¤ã‚’æ¸¡ã™ã€â€”â€”ã¨ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’èªè­˜ã—ã¾ã™ã€‚ã“ã‚Œã¯ ch01 ã§ç¤ºã—ãŸè»¸2ã®æ ¸å¿ƒã§ã‚ã‚Šã€æ¬¡ç« ä»¥é™ã®é™å®šç¶™ç¶šã‚„ Generator ã¸ã®æ©‹æ¸¡ã—ã®èµ·ç‚¹ã§ã™ã€‚

## ãªãœãƒ¢ãƒŠãƒ‰ãŒå¿…è¦ã‹

`ContChain` ã® `(a -> b)` ã®æ§‹é€ åŒ–ã«é€²ã‚€å‰ã«ã€ã²ã¨ã¤ç¢ºèªã™ã¹ãã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å‘½ä»¤ã‚’ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ã ã‘ã§ DSL ã¯æ›¸ã‘ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

```typescript
// å‘½ä»¤ã®ãƒªã‚¹ãƒˆâ€”â€”ã“ã‚Œã ã‘ã§ååˆ†ï¼Ÿ
const program: TalkInstruction[] = [
  { tag: "ask", prompt: "åå‰ã¯ï¼Ÿ" },
  { tag: "tell", message: "ã“ã‚“ã«ã¡ã¯" },  // â† å›ºå®šæ–‡å­—åˆ—ã—ã‹æ›¸ã‘ãªã„
];
```

ã“ã‚Œã¯ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ã€ã€Œå®Ÿè¡Œã‚’å¾Œã‹ã‚‰æ±ºã‚ã‚‰ã‚Œã‚‹ã€ã¨ã„ã†æ€§è³ªã‚’æº€ãŸã—ã¾ã™ãŒã€æ±ºå®šçš„ã«è¶³ã‚Šãªã„ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚**å¾Œã®å‘½ä»¤ãŒå‰ã®å‘½ä»¤ã®çµæœã«ä¾å­˜ã™ã‚‹**ã“ã¨ã‚’è¡¨ç¾ã§ãã¾ã›ã‚“ã€‚

```typescript
const name = yield* ask("åå‰ã¯ï¼Ÿ");
yield* tell(`ã“ã‚“ã«ã¡ã¯ã€${name}ã•ã‚“ï¼`);
//                       ^^^^ ask ã®çµæœã«ä¾å­˜
```

`tell` ã®å†…å®¹ãŒ `ask` ã®çµæœã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚å‘½ä»¤åˆ—ãŒé™çš„ã«æ±ºã¾ã‚‹ãªã‚‰ `Instruction[]` ã§ååˆ†ã§ã™ãŒã€ã“ã®**ä¾å­˜çš„ãªé€æ¬¡å®Ÿè¡Œ**ã‚’è¡¨ç¾ã™ã‚‹ã«ã¯ã€å‘½ä»¤ã®é–“ã«ã€Œçµæœã‚’å—ã‘å–ã£ã¦æ¬¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ±ºã‚ã‚‹é–¢æ•°ã€â€”â€”ã¤ã¾ã‚Š**ç¶™ç¶š**â€”â€”ãŒå¿…è¦ã§ã™ã€‚

```
å‘½ä»¤ â†’ çµæœ â†’ (çµæœã«åŸºã¥ã„ã¦æ¬¡ã®å‘½ä»¤ã‚’é¸ã¶) â†’ çµæœ â†’ ...
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
              ã“ã®é–¢æ•°ãŒ >>=ï¼ˆbindï¼‰ã®ç¬¬äºŒå¼•æ•°
```

ã“ã‚Œã¯ã¾ã•ã«ãƒ¢ãƒŠãƒ‰ã® `>>=`ï¼ˆbindï¼‰ã®å‹ã§ã‚ã‚Šã€ãƒ¢ãƒŠãƒ‰æ§‹é€ ãŒå¿…è¦ãªç†ç”±ã§ã™ã€‚

```
m >>= f
  m: å€¤ a ã‚’ç”Ÿã¿å‡ºã™è¨ˆç®—
  f: a ã‚’å—ã‘å–ã£ã¦æ¬¡ã®è¨ˆç®—ã‚’æ±ºã‚ã‚‹é–¢æ•°
```

å‰ç« ã§ `ContChain` ã® `(a -> b)` ã‚’ã€Œã¾ã é–¢æ•°ãŒæ®‹ã£ã¦ã„ã‚‹ã€ã¨æŒ‡æ‘˜ã—ã¾ã—ãŸã€‚ã“ã®é–¢æ•°ã¯æ¶ˆã›ã¾ã›ã‚“â€”â€”**ä¾å­˜çš„ãªé€æ¬¡å®Ÿè¡Œã®æœ¬è³ª**ã ã‹ã‚‰ã§ã™ã€‚æ¶ˆã™ã¹ããªã®ã¯é–¢æ•°ã®ä¸é€æ˜ã•ã§ã‚ã‚Šã€é–¢æ•°ã®å­˜åœ¨ãã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## ç¶™ç¶šã®ãƒã‚§ãƒ¼ãƒ³ã«æ®‹ã£ãŸé–¢æ•°

å‰ç« ã§ã€ç¶™ç¶šã®ãƒã‚§ãƒ¼ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã‚ˆã†ã¨ã—ãŸã¨ãã€æ¬¡ã®ã‚ˆã†ãªå‹ã«è¾¿ã‚Šç€ãã¾ã—ãŸã€‚

```haskell
data ContChain a
  = DoneChain
  | forall b. StepChain (a -> b) (ContChain b)
```

`StepChain` ã® `(a -> b)` ã¯ã€Œä»Šã®å€¤ `a` ã‚’å—ã‘å–ã‚Šã€ä½•ã‹ã‚’ã—ã¦æ¬¡ã®å€¤ `b` ã‚’ç”Ÿã¿å‡ºã™ã€é–¢æ•°ã§ã™ã€‚ã“ã®é–¢æ•°ã¯å®Œå…¨ã«ä¸é€æ˜ã§ã€Defunctionalization ã§ãã¦ã„ã¾ã›ã‚“ã€‚

### (a -> b) ã®ä¸­èº«ã‚’åˆ†è§£ã™ã‚‹

ã“ã® `(a -> b)` ã¯å®Ÿéš›ã«ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿä¸€èˆ¬ã®é–¢æ•° `(a -> b)` ã¯ä»»æ„ã®è¨ˆç®—ã‚’è¡¨ã›ã‚‹ã®ã§ã€ã“ã‚Œä»¥ä¸Šåˆ†è§£ã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ã“ã“ã§æ€ã„å‡ºã™ã¹ãã¯ã€ç§ãŸã¡ãŒæ§‹ç¯‰ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã¯ **DSL** ã ã¨ã„ã†ã“ã¨ã§ã™ã€‚

DSL ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€Œä½•ã‚‰ã‹ã®é›¢æ•£çš„ãªå‘½ä»¤ã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’ä½¿ã£ã¦æ¬¡ã«é€²ã‚€ã€ã¨ã„ã†æ§‹é€ ã‚’æŒã¡ã¾ã™ã€‚

```
ask "åå‰ã¯ï¼Ÿ"  â†’  (\name -> tell ("ã“ã‚“ã«ã¡ã¯ã€" ++ name) â†’ (\() -> ...))
```

ã“ã®å‰æã®ã‚‚ã¨ã§ `(a -> b)` ã‚’è¦³å¯Ÿã™ã‚‹ã¨ã€å…±é€šã®æ§‹é€ ãŒè¦‹ãˆã¦ãã¾ã™ã€‚

1. **ä½•ã‚‰ã‹ã®å‘½ä»¤ã‚’å®Ÿè¡Œã™ã‚‹**ï¼ˆ`ask "åå‰ã¯ï¼Ÿ"`ã€`tell "ã“ã‚“ã«ã¡ã¯"`ï¼‰
2. **å‘½ä»¤ã®çµæœã‚’å—ã‘å–ã‚‹**ï¼ˆ`ask` ãªã‚‰ `String`ã€`tell` ãªã‚‰ `()`ï¼‰
3. **ãã®çµæœã‚’ä½¿ã£ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€**

ã¤ã¾ã‚Š DSL ã®æ–‡è„ˆã§ã¯ã€`(a -> b)` ã¯ã€Œ**å‘½ä»¤ãƒ‡ãƒ¼ã‚¿ + çµæœã‚’å—ã‘å–ã‚‹ç¶™ç¶š**ã€ã«åˆ†è§£ã§ãã¾ã™ã€‚ã“ã‚Œã¯ä¸€èˆ¬çš„ãªå®šç†ã§ã¯ãªãã€ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯é›¢æ•£çš„ãªå‘½ä»¤ã®åˆ—ã§ã‚ã‚‹ã€ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä»®å®šã«åŸºã¥ãè¨­è¨ˆä¸Šã®é¸æŠã§ã™ã€‚

### å‘½ä»¤ã‚»ãƒƒãƒˆã‚’å‹ã§è¡¨ã™

ã“ã®åˆ†è§£ã‚’å‹ã§è¡¨ã—ã¾ã—ã‚‡ã†ã€‚å„å‘½ä»¤ã¯ã€Œå‘½ä»¤ã®ç¨®é¡ã¨å¼•æ•°ã€ã€Œçµæœã®å‹ã€ã€Œçµæœã‚’å—ã‘å–ã£ã¦æ¬¡ã«é€²ã‚€ç¶™ç¶šã€ã‚’æŒã¡ã¾ã™ã€‚

```haskell
data TalkF next
  = Ask String (String -> next)   -- å‘½ä»¤: Ask prompt
                                  -- çµæœå‹: String
                                  -- ç¶™ç¶š: String -> next
  | Tell String next              -- å‘½ä»¤: Tell msg
                                  -- çµæœå‹: ()
                                  -- ç¶™ç¶š: () -> next ï¼ˆç°¡ç•¥åŒ–ã—ã¦ç›´æ¥ nextï¼‰
```

å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `next` ãŒã€Œã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã«ä½•ãŒç¶šãã‹ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ `ContChain` ã® `(a -> b)` ã‚’æ§‹é€ åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚

```
ContChain:   StepChain  (a -> b)            (ContChain b)
                         ^^^^^^^^            ^^^^^^^^^^^^
                         ä¸é€æ˜ãªé–¢æ•°          æ®‹ã‚Šã®ãƒã‚§ãƒ¼ãƒ³

TalkF:       Ask "åå‰ï¼Ÿ" (String -> next)
             ^^^^^^^^^^   ^^^^^^^^^^^^^^^
             å‘½ä»¤ãƒ‡ãƒ¼ã‚¿    çµæœã‚’å—ã‘å–ã‚‹ç¶™ç¶š
             (è­˜åˆ¥å¯èƒ½)    (next ãŒã€Œæ®‹ã‚Šã€ã‚’è¡¨ã™)
```

ä¸é€æ˜ã ã£ãŸ `(a -> b)` ã®ã†ã¡ã€å‘½ä»¤éƒ¨åˆ†ï¼ˆ`Ask "åå‰ï¼Ÿ"`ï¼‰ãŒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è­˜åˆ¥å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ãŸã ã—ã€ç¶™ç¶šéƒ¨åˆ†ï¼ˆ`String -> next`ï¼‰ã¯é–¢æ•°ã®ã¾ã¾æ®‹ã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€Œ**å‘½ä»¤ã® Defunctionalization + ç¶™ç¶šã®æ§‹é€ åŒ–**ã€ã§ã™ã€‚

### ãªãœ next ã‚’å·®ã—æ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ â€” Functor

å‘½ä»¤ã‚’ãƒã‚§ãƒ¼ãƒ³ã«ã™ã‚‹ã«ã¯ã€ã‚ã‚‹å‘½ä»¤ã® `next`ï¼ˆç¶šãå…ˆï¼‰ã«åˆ¥ã®å‘½ä»¤ã‚’ç¹‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã° `ask` ã®å¾Œã« `tell` ã‚’ç¹‹ãã«ã¯ã€`ask` ã® `next` ã‚’ã€Œ`tell` ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰çµ‚äº†ã™ã‚‹è¨ˆç®—ã€ã«å·®ã—æ›¿ãˆã¾ã™ã€‚

ã“ã®ã€Œå‘½ä»¤ã®å†…å®¹ã‚’å¤‰ãˆãšã«ã€`next`ï¼ˆç¶šãå…ˆï¼‰ã ã‘ã‚’å·®ã—æ›¿ãˆã‚‹ã€æ“ä½œãŒ `fmap` ã§ã™ã€‚

```haskell
fmap f (Ask prompt k) = Ask prompt (f . k)  -- å‘½ä»¤ã¯ãã®ã¾ã¾ã€ç¶™ç¶šã®å…ˆã« f ã‚’åˆæˆ
fmap f (Tell msg next) = Tell msg (f next)   -- å‘½ä»¤ã¯ãã®ã¾ã¾ã€æ¬¡ã‚’å·®ã—æ›¿ãˆ
```

`fmap` ãŒå®šç¾©ã§ãã‚‹â€”â€”ã™ãªã‚ã¡ `TalkF` ãŒ **Functor** ã§ã‚ã‚‹â€”â€”ã“ã¨ã§ã€å‘½ä»¤ã‚’è‡ªç”±ã«ãƒã‚§ãƒ¼ãƒ³ã«çµ„ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## è‡ªç”±ãƒ¢ãƒŠãƒ‰ã®å®šç¾©

å‰ç¯€ã§å‘½ä»¤ã‚»ãƒƒãƒˆã‚’ Functor `f` ã¨ã—ã¦æ§‹é€ åŒ–ã—ã¾ã—ãŸã€‚`f` ã®å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `next` ã«ã€Œæ®‹ã‚Šã®è¨ˆç®—ã€ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€å‘½ä»¤ã‚’ãƒã‚§ãƒ¼ãƒ³çŠ¶ã«ç¹‹ã’ã‚‰ã‚Œã¾ã™ã€‚ã“ã®æ§‹é€ ã‚’å†å¸°çš„ã«å®šç¾©ã™ã‚‹ã¨ã€è‡ªç”±ãƒ¢ãƒŠãƒ‰ï¼ˆFree Monadï¼‰ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```haskell
data Free f a
  = Pure a                  -- è¨ˆç®—å®Œäº†ã€å€¤ a ã‚’æŒã¤
  | Free (f (Free f a))    -- å‘½ä»¤ f ã‚’ä¸€ã¤å®Ÿè¡Œã—ã€æ®‹ã‚Šã®è¨ˆç®—ãŒç¶šã
```

- `Pure a` â€” ã€Œã‚‚ã†ä½•ã‚‚ã—ãªãã¦ã„ã„ã€çµæœã¯ `a`ã€
- `Free (f (Free f a))` â€” ã€Œå‘½ä»¤ `f` ã® `next` ã« `Free f a`ï¼ˆæ®‹ã‚Šã®è¨ˆç®—ï¼‰ã‚’å…¥ã‚ŒãŸã‚‚ã®ã€

`TalkF` ã§å…·ä½“åŒ–ã™ã‚‹ã¨ã€`Free (Ask "åå‰ï¼Ÿ" (\name -> Free (Tell name (Pure ()))))` ã®ã‚ˆã†ã«ã€å‘½ä»¤ãŒå…¥ã‚Œå­ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¾ã™ã€‚`f` ãŒ Functor ã§ã‚ã‚Œã°ã€ã“ã®æ§‹é€ ã¯è‡ªå‹•çš„ã« Monad ã«ãªã‚Šã¾ã™ã€‚

## Monad ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

```haskell
instance Functor f => Monad (Free f) where
  Pure a >>= f = f a                      -- å€¤ãŒã‚ã‚Œã°ãã®ã¾ã¾é–¢æ•°ã‚’é©ç”¨
  Free fx >>= f = Free (fmap (>>= f) fx)  -- å‘½ä»¤ã®ã€Œä¸­ã€ã«æ½œã£ã¦å†å¸°çš„ã« >>= ã‚’é©ç”¨
```

`>>=`ï¼ˆbindï¼‰ã®å‹•ä½œï¼š

- `Pure a` ã®å ´åˆï¼šå˜ã« `f a` ã‚’è¿”ã™ã€‚ç¶™ç¶šã‚’ç›´æ¥é©ç”¨ã€‚
- `Free fx` ã®å ´åˆï¼šå‘½ä»¤ `fx` ã®ä¸­ã«ã‚ã‚‹ã€Œæ®‹ã‚Šã®è¨ˆç®—ã€ã«å¯¾ã—ã¦å†å¸°çš„ã« `>>= f` ã‚’é©ç”¨ã™ã‚‹ã€‚ã¤ã¾ã‚Šã€å‘½ä»¤ãƒã‚§ãƒ¼ãƒ³ã®**æœ«å°¾ã«æ–°ã—ã„è¨ˆç®—ã‚’æ¥ãæœ¨**ã™ã‚‹ã€‚ã“ã®ã€Œæ¥ãæœ¨ã€ã¯æ¯å›ãƒã‚§ãƒ¼ãƒ³ã®å…ˆé ­ã‹ã‚‰æœ«ç«¯ã¾ã§ã‚’è¾¿ã‚Šç›´ã™ãŸã‚ã€ãƒã‚§ãƒ¼ãƒ³ãŒé•·ããªã‚‹ã¨æ€§èƒ½å•é¡Œã«ç¹‹ãŒã‚Šã¾ã™ï¼ˆå¾Œã®ç« ã§è§£æ±ºã—ã¾ã™ï¼‰ã€‚

## å…·ä½“ä¾‹: å…¥å‡ºåŠ›ã® DSL

å‘½ä»¤ã‚»ãƒƒãƒˆã‚’ Functor ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚

```haskell
data TalkF next
  = Ask String (String -> next)   -- è³ªå•ã—ã¦ã€ç­”ãˆã‚’ä½¿ã£ã¦æ¬¡ã¸
  | Tell String next              -- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦æ¬¡ã¸
  deriving Functor
```

`TalkF` ã®å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `next` ãŒã€Œæ¬¡ã®è¨ˆç®—ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚`deriving Functor` ã§ã€`next` ã®éƒ¨åˆ†ã«é–¢æ•°ã‚’é©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

å‘½ä»¤ã‚’ Free ãƒ¢ãƒŠãƒ‰ã«æŒã¡ä¸Šã’ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚

```haskell
liftFree :: Functor f => f a -> Free f a
liftFree fx = Free (fmap Pure fx)
-- å‘½ä»¤ fx ã®ã€Œæ¬¡ã®è¨ˆç®—ã€ã‚’ Pureï¼ˆ= è¨ˆç®—å®Œäº†ï¼‰ã«ã—ã¦åŒ…ã‚€
```

ã“ã‚Œã‚’ä½¿ã£ã¦ä¾¿åˆ©ãªå‘½ä»¤é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

```haskell
ask :: String -> Free TalkF String
ask prompt = liftFree (Ask prompt id)

tell :: String -> Free TalkF ()
tell msg = liftFree (Tell msg ())
```

do è¨˜æ³•ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ›¸ã‘ã¾ã™ã€‚

```haskell
talkProgram :: Free TalkF String
talkProgram = do
  name <- ask "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  tell ("ã“ã‚“ã«ã¡ã¯ã€" ++ name ++ "ã•ã‚“ï¼")
  age <- ask "å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  tell (age ++ "æ­³ã§ã™ã­ã€‚")
  pure name
```

ã“ã® `talkProgram` ã¯ **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ** ã§ã™ã€‚å®Ÿè¡Œã¯ã¾ã è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

## ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿: ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å®Ÿè¡Œã¸

åŒã˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å¯¾ã—ã¦ç•°ãªã‚‹ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã‚’å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ã®ãŒ Free ãƒ¢ãƒŠãƒ‰ã®å¼·ã¿ã§ã™ã€‚

```haskell
-- IO ã§å¯¾è©±çš„ã«å®Ÿè¡Œ
runTalkIO :: Free TalkF a -> IO a
runTalkIO (Pure a) = pure a
runTalkIO (Free (Ask prompt next)) = do
  putStrLn prompt
  input <- getLine
  runTalkIO (next input)
runTalkIO (Free (Tell msg next)) = do
  putStrLn msg
  runTalkIO next

-- ç´”ç²‹ãªã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
runTalkPure :: [String] -> Free TalkF a -> (a, [String])
```

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®šç¾©ã¨å®Ÿè¡ŒãŒåˆ†é›¢ã•ã‚Œã¾ã—ãŸã€‚ã—ã‹ã—ã“ã®ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã«ã¯ã€ã‚‚ã£ã¨é‡è¦ãªæ§‹é€ ãŒéš ã‚Œã¦ã„ã¾ã™ã€‚

## ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã®èªè­˜

`runTalkIO` ã‚’ã‚‚ã†ä¸€åº¦è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã®ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

```haskell
runTalkIO (Pure a) = pure a
runTalkIO (Free (Ask prompt next)) = do
  putStrLn prompt
  input <- getLine
  runTalkIO (next input)     -- ç¶™ç¶šã«å€¤ã‚’æ¸¡ã—ã¦å†é–‹
runTalkIO (Free (Tell msg next)) = do
  putStrLn msg
  runTalkIO next             -- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
```

1. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®**å…ˆé ­ã‚’è¦—ã**ï¼ˆ`Pure` ã‹ `Free` ã‹ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒï¼‰
2. å‘½ä»¤ã‚’**å‡¦ç†ã™ã‚‹**ï¼ˆ`putStrLn`ã€`getLine`ï¼‰
3. ç¶™ç¶šã«**çµæœã‚’æ¸¡ã™**ï¼ˆ`next input`ã€`next`ï¼‰
4. å†å¸°çš„ã«**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸**

ã“ã‚Œã¯**ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ**â€”â€”ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä¸€å‘½ä»¤ãšã¤å‡¦ç†ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæˆç«‹ã™ã‚‹ã®ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ Free ãƒ¢ãƒŠãƒ‰ã«ã‚ˆã£ã¦**ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å…·è±¡åŒ–**ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚`runTalkIO` ã¯ Free ã®æ§‹é€ ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§è¦—ãã€å‘½ä»¤ã®ç¨®é¡ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²ã—ã¦ã„ã¾ã™ã€‚

ä¸€èˆ¬ã®ãƒ¢ãƒŠãƒ‰â€”â€”ãŸã¨ãˆã° `Reader` ã‚„ `IO`â€”â€”ã® `>>=` ã§ã¯ã€ã“ã†ã—ãŸã€Œè¦—ãè¦‹ã€ã¯ã§ãã¾ã›ã‚“ã€‚`IO a >>= f` ã¯å†…éƒ¨ã§ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹ãŒä¸é€æ˜ã§ã‚ã‚Šã€å¤–ã‹ã‚‰å‘½ä»¤ã‚’ä¸€ã¤å–ã‚Šå‡ºã—ã¦å‡¦ç†ã‚’åˆ†å²ã™ã‚‹ã€ã¨ã„ã†æ“ä½œã¯åŸç†çš„ã«ä¸å¯èƒ½ã§ã™ã€‚Free ãƒ¢ãƒŠãƒ‰ãŒ**ãƒ‡ãƒ¼ã‚¿**ã§ã‚ã‚‹ã‹ã‚‰ã“ãã€ä¸­ã‚’è¦—ã‘ã‚‹ã®ã§ã™ã€‚

æ¬¡ç« ã§ã¯å‘½ä»¤ã¨ç¶™ç¶šã‚’ã‚ˆã‚Šæ˜ç¢ºã«åˆ†é›¢ã—ï¼ˆFreer ãƒ¢ãƒŠãƒ‰ï¼‰ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã®æ§‹é€ ã‚’ä¸€èˆ¬åŒ–ã—ã¾ã™ã€‚

## Free ãƒ¢ãƒŠãƒ‰ã®èª²é¡Œ

Free ãƒ¢ãƒŠãƒ‰ã¯å¼·åŠ›ã§ã™ãŒã€å‘½ä»¤ã‚»ãƒƒãƒˆ `f` ã« **Functor åˆ¶ç´„ãŒå¿…è¦** ã§ã™ã€‚

```haskell
data TalkF next
  = Ask String (String -> next)   -- â† ã“ã® (String -> next) ãŒ Functor ã®ãŸã‚ã«å¿…è¦
  | Tell String next
```

`fmap` ã¯ã€Œå‘½ä»¤ã®å†…å®¹ã‚’å¤‰ãˆãšã«ã€`next`ï¼ˆç¶šãå…ˆï¼‰ã ã‘ã‚’å·®ã—æ›¿ãˆã‚‹ã€æ“ä½œã§ã™ã€‚`Tell msg next` ã®ã‚ˆã†ã« `next` ãŒç›´æ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚ã‚Œã°å·®ã—æ›¿ãˆã¯ç°¡å˜ã§ã™ãŒã€`Ask` ã®å ´åˆã€çµæœï¼ˆ`String`ï¼‰ã¯ç¶™ç¶šé–¢æ•°ã®è¿”ã‚Šå€¤ã®ä¸­ã«é–‰ã˜è¾¼ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚`next` ã‚’å·®ã—æ›¿ãˆã‚‹ã«ã¯ã€ç¶™ç¶šã‚’å¼•æ•°ã¨ã—ã¦æŒã¡ `(String -> next)` ã¨ã„ã†å½¢ã«ã™ã‚‹â€”â€”ã¤ã¾ã‚Š `next` ã‚’æ§‹é€ ã®ä¸­ã«éœ²å‡ºã•ã›ã‚‹â€”â€”å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã® `(String -> next)` ã¯ Functor ã® `fmap` ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã ã‘ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚å‰ç¯€ã§ã€Œå‘½ä»¤ã® Defunctionalization + ç¶™ç¶šã®æ§‹é€ åŒ–ã€ã¨è¿°ã¹ã¾ã—ãŸãŒã€ã“ã® `(String -> next)` ã¯ã¾ã•ã«æ§‹é€ åŒ–ã•ã‚ŒãŸã¾ã¾æ®‹ã£ã¦ã„ã‚‹ç¶™ç¶šã®éƒ¨åˆ†ã§ã‚ã‚Šã€å®šå‹çš„ã§ã€å‘½ä»¤ã®æœ¬è³ªçš„ãªæƒ…å ±ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚

æ¬¡ç« ã§ã€ã“ã® Functor åˆ¶ç´„ã‚’å–ã‚Šé™¤ãæ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

> ğŸ“– å¯¾å¿œã‚³ãƒ¼ãƒ‰: [`haskell/src/Free.hs`](../haskell/src/Free.hs)
